@page "/flows"
@using System.IO.Compression
@using System.Text.Json
@using MaIN.Models.Rag
@using MainFE.Components.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.FluentUI.AspNetCore.Components
@using Message = MainFE.Components.Models.Message
@inject HttpClient Http
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>🌀 Flows</PageTitle>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/flows.css">
<link rel="stylesheet" href="css/chat.css">

@switch (_mode)
{
    case AgentsFlowPageMode.List:
        <FluentGrid Class="flow-grid" Justify="JustifyContent.Center">
            <FluentGridItem lg="2"></FluentGridItem> 
            <FluentGridItem lg="8" md="4" sm="6" xs="12" Style="">
                <FluentInputFile Id="my-zip-uploader"
                                 Mode="InputFileMode.SaveToTemporaryFolder"
                                 Multiple="true"
                                 MaximumFileCount="4"
                                 MaximumFileSize="@(10 * 1024 * 1024)"
                                 Accept=".zip"
                                 @* @bind-ProgressPercent="@ProgressPercent" *@
                                 OnCompleted="@OnCompletedAsync"
                                 Style="background-color: transparent !important; color: whitesmoke !important;">
                    <ChildContent>
                        <label for="my-zip-uploader" class="cleanup-button"
                               style="text-decoration: none !important; font-style: normal; width: 20rem; font-size: 20px !important; color: white">
                            <i class="fas fa-stream"></i> Import flow
                            @* <button class="cleanup-button" style="width: 20rem; font-size: 20px !important;"> *@
                            @*     <i class="fas fa-stream"></i> Import flow *@
                            @* </button> *@
                        </label>
                    </ChildContent>
                </FluentInputFile>
            </FluentGridItem>
            <FluentGridItem lg="2">
                @* <button @onclick="NavigateToDemo" class="cleanup-button" style="font-size: 13px !important; background-color: #4CAF50 !important; margin-left: 3rem"> *@
                @*     <i class="fas fa-flask"></i> Demo *@
                @* </button> *@
            </FluentGridItem>
            <FluentProgressRing Visible="_loading"></FluentProgressRing>

            @foreach (var flow in flows)
            {
                <FluentGridItem lg="3" md="4" sm="6" xs="12" Class="flow-tile-container">
                    <div class="flow-tile" @onclick="() => ViewFlowDetails(flow.Id)">
                        <div class="flow-header">
                            <FluentBadge Appearance="Appearance.Neutral" Class="flow-name-badge">
                                @flow.Name 🌀
                            </FluentBadge>
                            <button class="remove-btn" @onclick:stopPropagation="true" @onclick="() => RemoveFlow(flow.Id)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <div class="flow-description-box">
                            <p>@flow.Description</p>
                        </div>
                        <div class="flow-agents">
                            @foreach (var agent in flow.Agents.Select((value, index) => new { value, index }))
                            {
                                <div class="agent-item">
                                    <span class="agent-number">@(agent.index + 1). @agent.value.Name</span>
                                    <div class="agent-badges">
                                        <span class="model-badge">@agent.value.Model</span>
                                        <span class="steps-badge">
                                            @(agent.value.Context.Steps.Count) steps
                                        </span>
                                    </div>
                                    @if (IsEntryPoint(flow, agent.value))
                                    {
                                        <i class="fas fa-sign-in-alt entry-icon" title="Entry Point"></i>
                                    }
                                    else if (IsExitPoint(agent.value))
                                    {
                                        <i class="fas fa-sign-out-alt exit-icon" title="Exit Point"></i>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </FluentGridItem>
            }
            <FluentGridItem lg="12"></FluentGridItem>
            <FluentGridItem lg="3"></FluentGridItem>
            <FluentGridItem lg="6" md="12" sm="12" xs="12" Style="margin: auto">
                @* <FluentInputFile Id="my-zip-uploader" *@
                @*                  Mode="InputFileMode.SaveToTemporaryFolder" *@
                @*                  Multiple="true" *@
                @*                  MaximumFileCount="4" *@
                @*                  MaximumFileSize="@(10 * 1024 * 1024)" *@
                @*                  Accept=".zip" *@
                @*                  $1$ @bind-ProgressPercent="@ProgressPercent" #1# *@
                @*                  OnCompleted="@OnCompletedAsync" *@
                @*                  Style="background-color: transparent !important;"> *@
                @*     <ChildContent> *@
                @*         <label for="my-zip-uploader" class="cleanup-button" *@
                @*                style="text-decoration: none !important; font-style: normal; width: 20rem; font-size: 20px !important;" > *@
                @*             <i class="fas fa-stream"></i> Import flow *@
                @*             $1$ <button class="cleanup-button" style="width: 20rem; font-size: 20px !important;"> #1# *@
                @*             $1$     <i class="fas fa-stream"></i> Import flow #1# *@
                @*             $1$ </button> #1# *@
                @*         </label> *@
                @*     </ChildContent> *@
                @* </FluentInputFile> *@
            </FluentGridItem>
            <FluentGridItem lg="3"></FluentGridItem>
        </FluentGrid>
        break;
        
    case AgentsFlowPageMode.Details:
<div class="page-container">
    <div class="content-container">
        <div class="agents-flow-container">
            <div class="back-button-container">
                <button @onclick="GoBack" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            <div class="agent-grid">
                @foreach (var level in AgentLevels)
                {
                <div class="agent-level">
                    @foreach (var agent in level)
                    {
                    <div class="agent-card @(agent.AgentDependencyId != null ? "has-dependency" : "") @GetProcessingClass(agent)"
                         data-dependency-id="@agent.AgentDependencyId">
                        <div class="agent-header">
                            <h3>@agent.Name</h3>
                        </div>
                        <span class="badge">@agent.Model</span>
                        <div class="agent-body">
                            <div class="instruction-container">
                                <span>Instruction</span>
                                <button @onclick="() => ShowInstruction(agent)" class="instruction-button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="state-container">
                                <span>State: @agent.State</span>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
        </div>
    </div>

    <div class="input-container">
        <FluentInputFile Id="my-file-uploader"
                         Mode="InputFileMode.SaveToTemporaryFolder"
                         Multiple="true"
                         MaximumFileCount="4"
                         MaximumFileSize="@(10 * 1024 * 1024)"
                         Accept=".csv, .json, .txt"
                         ProgressPercent="@ProgressPercent"
                         OnCompleted="@OnFileCompletedAsync"
                         Style="background-color: transparent !important; width: 3rem">
            <ChildContent>
                <label for="my-file-uploader" class="attachment-btn">
                    <FluentIcon Value="@(new Icons.Filled.Size32.Attach())"
                                Color="@_filesAttachedClass" Style="margin-right: 5px; margin-top: 5px; background-color: transparent">
                    </FluentIcon>
                </label>
            </ChildContent>
        </FluentInputFile>

        <input @bind-value="_ask" @bind-value:event="oninput" placeholder="Enter your prompt here..." @onkeydown="CheckEnterKey" class="inp">

        <FluentButton IconStart="@(new Icons.Filled.Size28.Send())" BackgroundColor="rgba(0, 0, 0, 0)" Style="margin-top: 5px; background-color: transparent"
                      Appearance="Appearance.Lightweight"
                      Loading="@IsLoading"
                      OnClick="@(() => SendAsync(_ask))">
        </FluentButton>
    </div>
    <FluentProgress Visible="@(IsLoading)" style="width: 100%;"></FluentProgress>
</div>
break;
}

@code {

    // Models
    public List<List<AgentDto>> AgentLevels { get; set; } = [];
    AgentFlowDto newFlow;
    List<string> models = new();
    List<AgentFlowDto> flows = new();
    string _selectedModel = string.Empty;
    ChatDto _selectedChat = new() { Messages = new() };
    AgentDto _entryAgent = new();
    AgentFlowDto selectedFlow = new();
    AgentsFlowPageMode _mode = AgentsFlowPageMode.List;
    bool _loading = false;
    private HubConnection? hubConnection;
    
    //CHAT
    [Parameter] public ChatDto? Chat { get; set; }
    [Parameter] public string SelectedModel { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string? CustomName { get; set; }
    [Parameter] public bool IsRagChat { get; set; }
    [Parameter] public string? AgentId { get; set; }
    [Parameter] public FluentInputFileEventArgs[] Images { get; set; }
    [Parameter] public bool Translate { get; set; }

    public FluentInputFileEventArgs[] Files = [];
    private bool _filesAttached = false;
    private Color _filesAttachedClass => _filesAttached ? Color.Success : Color.Accent;
    private string _ask = string.Empty;
    private string _displayName => CustomName ?? SelectedModel;
    int ProgressPercent = 0;
    
    private async Task CheckEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendAsync(_ask);
        }
    }
    
    private async Task SendAsync(string message)
    {
        IsLoading = true;
        if (!string.IsNullOrWhiteSpace(message))
        {
            _selectedChat.Messages.Add(new Message { Role = Role.User.ToString(), Content = message });
            _selectedChat.Model = _entryAgent.Model;

            var apiResponse = await Http.PostAsJsonAsync($"{ExtensionMethods.GetApiUrl()}/api/agents/{_entryAgent.Id}/process", _selectedChat);

            if (apiResponse.IsSuccessStatusCode)
            {
                var response = await apiResponse.Content.ReadFromJsonAsync<ChatDto>();
                if (response != null)
                {
                    Chat = response;
                }
            }

            IsLoading = false;
            _ask = string.Empty;
        }
    }
    
    private async Task OnFileCompletedAsync(IEnumerable<FluentInputFileEventArgs> files)
    {
        Files = files.ToArray();
        _filesAttached = true;
    }

    protected override async Task OnInitializedAsync()
    {
        Http.Timeout = TimeSpan.FromMinutes(10);
        await LoadFlowsAsync();
    }

    private List<List<AgentDto>> OrganizeAgentsIntoLevels(List<AgentDto> agents)
    {
        // Implement your logic to organize agents into levels
        // This is a placeholder implementation
        var levels = new List<List<AgentDto>>();
        var currentLevel = new List<AgentDto>();

        foreach (var agent in agents)
        {
            if (currentLevel.Count >= 3 || (currentLevel.Count > 0 && agent.AgentDependencyId == null))
            {
                levels.Add(currentLevel);
                currentLevel = new List<AgentDto>();
            }
            currentLevel.Add(agent);
        }

        if (currentLevel.Count > 0)
        {
            levels.Add(currentLevel);
        }

        return levels;
    }

    public void CalculateAgentDependencies(List<AgentDto> agents)
    {
        var agentDictionary = agents.ToDictionary(a => a.Id, a => a);

        foreach (var agent in agents)
        {
            if (agent.Context?.Steps != null)
            {
                foreach (var step in agent.Context.Steps)
                {
                    if (step.StartsWith("REDIRECT", StringComparison.OrdinalIgnoreCase))
                    {
                        var parts = step.Split('+');
                        if (parts.Length >= 2 )
                        {
                            if (agentDictionary.TryGetValue(parts[1], out var dependentAgent))
                            {
                                dependentAgent.AgentDependencyId = agent.Id;
                                break;
                            }
                        }
                    }
                }
            }
        }
    }
    
    private async Task LoadChatAsync(string agentId)
    {
        var response = await Http.GetFromJsonAsync<ChatDto>($"{ExtensionMethods.GetApiUrl()}/api/agents/{agentId}/chat");
        if (response != null)
        {
            _selectedChat = response;
            _selectedModel = response.Model;
        }
    }
    
    private string GetProcessingClass(AgentDto agent)
    {
        return agent.IsProcessing ? "loading-border" : string.Empty;
    }

    private string GetAgentId(AgentDto agent) => $"agent-{agent.Id}";
    private async Task RemoveFlow(string flowId)
    {
        await Http.DeleteAsync($"{ExtensionMethods.GetApiUrl()}/api/flows/{flowId}");
        await LoadFlowsAsync();
    }

    private async Task Cleanup(string selectedAgentId) //Is it still valid?
    {
        await Http.PutAsync($"{ExtensionMethods.GetApiUrl()}/api/agents/{selectedAgentId}/chat/reset", default);
        await LoadChatAsync(selectedAgentId);
    }

    private void ShowInstruction(AgentDto agent)
    {
        // Implement your instruction display logic here
    }
    
    private async Task LoadFlowsAsync()
    {
        var response = await Http.GetFromJsonAsync<List<AgentFlowDto>>($"{ExtensionMethods.GetApiUrl()}/api/flows");
        if (response != null)
        {
            flows = response;
        }
    }

    private async Task ViewFlowDetails(string agentId)
    {
        selectedFlow = flows.FirstOrDefault(a => a.Id == agentId)!;
        CalculateAgentDependencies(selectedFlow.Agents);
        AgentLevels = OrganizeAgentsIntoLevels(selectedFlow.Agents);
        _entryAgent = AgentLevels.First().First();
        await LoadChatAsync(_entryAgent.Id);
        _mode = AgentsFlowPageMode.Details;
        
        newFlow = new()
        {
            Id = Guid.NewGuid().ToString()
        };
        
        hubConnection = new HubConnectionBuilder()
            .WithUrl($"{ExtensionMethods.GetApiUrl()}/diagnostics")
            .Build();
        
        hubConnection!.On<JsonElement>("ReceiveAgentUpdate", (jsonElement) =>
        {
            var agentId = jsonElement.GetProperty("agentId").GetString();
            var isProcessing = jsonElement.GetProperty("isProcessing").GetBoolean();

            var agent = selectedFlow.Agents.FirstOrDefault(a => a.Id.ToString() == agentId);
            if (agent != null)
            {
                agent.IsProcessing = isProcessing;
                agent.State = isProcessing ? AgentProcessingState.Running : AgentProcessingState.Idle;
                InvokeAsync(StateHasChanged);
            }
        });

        await hubConnection.StartAsync();
        //await LoadChatAsync(selectedAgent.Id); TODO fix this the way we can see real entrypoint for flow
    }

    private async Task CreateFlow()
    {
        _loading = true;
        //  newFlow.Context.Steps = ["START"];
        newFlow.Id = Guid.NewGuid().ToString();
        var response = await Http.PostAsJsonAsync($"{ExtensionMethods.GetApiUrl()}/api/flows", newFlow);
        if (response.IsSuccessStatusCode)
        {
            newFlow = new(); // Reset the form
            await LoadFlowsAsync(); // Refresh the agents list
            _loading = false;
            _mode = AgentsFlowPageMode.List; // Switch back to list mode
        }
    }
    
    private void GoBack()
    {
        _mode = AgentsFlowPageMode.List;
    }

    private bool IsEntryPoint(AgentFlowDto flow, AgentDto agent)
    {
        return flow.Agents.All(a => !a.Context.Steps.Any(step => step.Contains("REDIRECT") && step.Contains(agent.Id))) || flow.Agents.Count == 1;
    }

    private bool IsExitPoint(AgentDto agent)
    {
        return !agent.Context.Steps.Any(step => step.StartsWith("REDIRECT")) || agent.Context.Steps.Count == 1;
    }
    
    private void SwitchToCreate()
    {
        _mode = AgentsFlowPageMode.Create;
    }

    private async Task OnCompletedAsync(IEnumerable<FluentInputFileEventArgs> files)
    {
        _loading = true;
        List<AgentDto> agents = new List<AgentDto>();
        var desc = string.Empty;

        foreach (var fileEvent in files)
        {
            var file = fileEvent.LocalFile; // Access the uploaded file
            if (file != null && fileEvent.Name.EndsWith(".zip"))
            {
                await using var stream = file.Open(FileMode.Open);
                // Create a ZipArchive object from the stream
                using var zipArchive = new ZipArchive(stream, ZipArchiveMode.Read);
                foreach (var entry in zipArchive.Entries)
                {
                    if (entry.FullName.EndsWith("description.txt"))
                    {
                        await using var textStream = entry.Open();
                        using var textReader = new StreamReader(textStream);
                        var txtString = await textReader.ReadToEndAsync();
                        desc = txtString;
                    }

                    if (!entry.FullName.EndsWith(".json", StringComparison.OrdinalIgnoreCase)) continue;
                    // Extract JSON file
                    await using var jsonStream = entry.Open();
                    using var reader = new StreamReader(jsonStream);
                    var jsonString = await reader.ReadToEndAsync();

                    // Process the JSON string (e.g., deserialize it into an object)
                    var agent = JsonSerializer.Deserialize<AgentDto>(jsonString);

                    // Now, you can work with the jsonObject
                    agents.Add(agent!);
                }
            }
        }

        var newFlow = new AgentFlowDto()
        {
            Agents = agents,
            Name = files.First().Name.Split('.').First(),
            Description = desc
        };

        await Http.PostAsJsonAsync($"{ExtensionMethods.GetApiUrl()}/api/flows", newFlow);
        await LoadFlowsAsync();
        _loading = false;
    }
}
