@page "/chat"
@using MainFE.Components.Models
@using Markdig
@using Microsoft.FluentUI.AspNetCore.Components
@using NAssetNameGenerator
@using Message = MainFE.Components.Models.Message
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>💬 Chat</PageTitle>
<link rel="stylesheet" href="css/chat.css">

<FluentGrid Class="containerbox" Spacing="1" Justify="JustifyContent.FlexStart">
    <FluentGridItem lg="3" sm="12" xs="12" Class="sidebar">
        <FluentButton OnClick="@NewChatAsync"
                      IconStart="@(new Icons.Regular.Size24.Add())" BackgroundColor="rgba(0, 0, 0, 0.53)" Appearance="Appearance.Accent"
                      Style="margin-bottom: 10px;">
            New Chat
        </FluentButton>
        @foreach (var chat in chats)
        {
            <div class="chat-item">
                <FluentCard @onclick="() => LoadChatAsync(chat.Id)"
                            Class="@GetChatCardClass(chat)">
                    Chat - @chat.Name
                </FluentCard>
                <FluentButton OnClick="() => DeleteChatAsync(chat.Id)"
                              IconStart="@(new Icons.Filled.Size16.Delete())" BackgroundColor="rgba(0,0,0,0)" Appearance="Appearance.Accent"
                              Class="delete-button">
                </FluentButton>
            </div>
        }
    </FluentGridItem>
    <FluentGridItem lg="7" xs="12" Class="chat-container">
        <div class="messages-container">
            @foreach (var message in messages)
            {
                <span class="@(message.Role == Role.User.ToString() ? "message-role-user" : "message-role-bot")">@GetRoleLabel(message.Role)</span>
                <FluentCard class="@(message.Role == Role.User.ToString() ? "message-card user-message" : "message-card bot-message")">
                    @((MarkupString)((message.Role == Role.User.ToString() ? message.Content : 
    Markdown.ToHtml((string)message.Content!,
        new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .Build())) ?? string.Empty))
                </FluentCard>
            }
            @if (loading)
            {
                <span class="message-role-bot">@selectedModel</span>
                <FluentProgressRing Visible="loading"></FluentProgressRing>
            }
        </div>
        <div class="input-container">
            <input @bind-value="ask" @bind-value:event="oninput" placeholder="Enter your prompt here..." @onkeydown="CheckEnterKey" class="inp">
            <FluentButton IconStart="@(new Icons.Filled.Size28.Send())" BackgroundColor="rgba(0, 0, 0, 0)" Style="margin-top: 5px; background-color: transparent"
                          Appearance="Appearance.Lightweight"
                          Loading="@loading"
                          OnClick="@(() => SendAsync(ask))">
            </FluentButton>
        </div>
        <FluentProgress Visible="@(loading)" style="width: 100%;"></FluentProgress>
    </FluentGridItem>
    <FluentGridItem lg="1" xs="12" Style="padding: 10px">
        <span class="model-label">Model:</span>
        <select id="modelSelect" @bind="selectedModel" Class="select-element">
            @foreach (var model in models)
            {
                <option Value="@model">@model</option>
            }
        </select>
    </FluentGridItem>
</FluentGrid>

@code {
    // Models
    List<string> models = [];
    string selectedModel = string.Empty;
    
    // Data
    List<Message> messages = new();
    List<ChatDto> chats = new();
    ChatDto selectedChat = new();
    string ask = string.Empty;
    bool loading = false;

    private async Task CheckEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendAsync(ask);
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        Http.Timeout = TimeSpan.FromMinutes(10);
        await LoadChatsAsync();
        await LoadModelsAsync();
    }

    private async Task LoadChatsAsync()
    {
        
        var response = await Http.GetAsync($"{ExtensionMethods.GetApiUrl()}/api/chats");
        if (response.IsSuccessStatusCode)
        {
            chats = await response.Content.ReadFromJsonAsync<List<ChatDto>>() ?? [];
        }
    }

    private async Task LoadModelsAsync()
    {
        var response = await Http.GetAsync($"{ExtensionMethods.GetApiUrl()}/api/chats/models");
        if (response.IsSuccessStatusCode)
        {
            models = await response.Content.ReadFromJsonAsync<List<string>>() ?? [];
            selectedModel = models!.First();
        }
    }

    private async Task LoadChatAsync(string chatId)
    {
        var response = await Http.GetFromJsonAsync<ChatDto>($"{ExtensionMethods.GetApiUrl()}/api/chats/{chatId}");
        if (response != null)
        {
            messages = response.Messages;
            selectedChat = response;
            chats.ForEach(c => c.IsSelected = c.Id == chatId);
        }
    }

    private async Task DeleteChatAsync(string id)
    {
        var response = await Http.DeleteAsync($"{ExtensionMethods.GetApiUrl()}/api/chats/{id}");
        if (response.IsSuccessStatusCode)
        {
            chats.RemoveAll(c => c.Id == id);
            if (selectedChat.Id == id)
            {
                selectedChat = new();
                messages.Clear();
            }
        }
    }

    private async Task NewChatAsync()
    {
        messages.Clear();
        var newChatRequest = new ChatRequest
        {
            Model = selectedModel,
            Messages = new List<Message>(),
            Name = $"{AssetName.NewName()} | {DateTime.Now.ToShortDateString()}",
            Stream = false,
        };

        var result = await Http.PostAsJsonAsync($"{ExtensionMethods.GetApiUrl()}/api/chats", newChatRequest);

        if (result.IsSuccessStatusCode)
        {
            var response = await result.Content.ReadFromJsonAsync<ChatDto>();
            if (response != null)
            {
                response.IsSelected = true;
                selectedChat = response;
                chats.Add(response);
                await LoadChatAsync(response.Id);
            }
        }
    }

    private async Task SendAsync(string message)
    {
        loading = true;
        if (!string.IsNullOrWhiteSpace(message))
        {
            messages.Add(new Message { Role = Role.User.ToString(), Content = message });
            selectedChat.Messages = messages;
            selectedChat.Model = selectedModel;

            var replyServerOllama = await Http.PostAsJsonAsync($"{ExtensionMethods.GetApiUrl()}/api/chats/complete", selectedChat);

            if (replyServerOllama.IsSuccessStatusCode)
            {
                var response = await replyServerOllama.Content.ReadFromJsonAsync<ChatResponse>();
                if (response != null)
                {
                    messages.Add(response.Message);
                }
            }
            loading = false;
            ask = string.Empty;
        }
    }

    // Helper methods
    private string GetChatCardClass(ChatDto chat) => chat.IsSelected ? "selected-chat-card" : "chat-card";
    private string GetRoleLabel(string role) => role == Role.User.ToString() ? "( ͡° ͜ʖ ͡°) User" : $"🤖 {selectedModel}";
}